// Generated by CoffeeScript 1.3.3
(function() {

  $.fn.clipthru = function(options) {
    var addIdToBlocks, allBlocks, allClones, attachListeners, clipOverlay, collidingBlocks, createOverlayClones, defaults, getAllBlocks, getCollidingBlocks, getCollisionArea, getOverlayOffset, init, overlay, overlayOffset, refresh, settings, updateOverlayClones;
    defaults = {
      simpleMode: false,
      dataAttribute: 'jq-clipthru',
      updateOnScroll: true,
      updateOnResize: true,
      updateOnZoom: true,
      autoUpdate: false,
      autoUpdateInterval: 100,
      debug: false
    };
    settings = $.extend(defaults, options);
    overlay = $(this);
    overlayOffset = null;
    allBlocks = null;
    allClones = null;
    collidingBlocks = [];
    getAllBlocks = function() {
      return allBlocks = $("[data-" + settings.dataAttribute + "]");
    };
    addIdToBlocks = function() {
      var i;
      i = 0;
      return allBlocks.each(function() {
        $(this).data("" + settings.dataAttribute + "-id", i);
        return i++;
      });
    };
    createOverlayClones = function() {
      return allBlocks.each(function() {
        var clone;
        clone = overlay.clone();
        clone.addClass("" + settings.dataAttribute + "-clone");
        clone.addClass($(this).data(settings.dataAttribute));
        clone.data("" + settings.dataAttribute + "-id", $(this).data("" + settings.dataAttribute + "-id"));
        if (allClones) {
          return allClones = allClones.add(clone);
        } else {
          return allClones = clone;
        }
      });
    };
    updateOverlayClones = function() {
      return allClones.each(function() {
        if (collidingBlocks.hasOwnProperty($(this).data("" + settings.dataAttribute + "-id"))) {
          if (!document.body.contains(this)) {
            $(this).insertAfter(overlay);
          }
          return clipOverlay(this, getCollisionArea(collidingBlocks[$(this).data("" + settings.dataAttribute + "-id")]));
        } else {
          return $(this).detach();
        }
      });
    };
    getCollisionArea = function(blockOffset) {
      var clipOffset;
      clipOffset = [];
      clipOffset.push(overlayOffset.height - (overlayOffset.bottom - blockOffset.top));
      clipOffset.push(blockOffset.right - overlayOffset.left);
      clipOffset.push(blockOffset.bottom - overlayOffset.top);
      clipOffset.push(overlayOffset.width - (overlayOffset.right - blockOffset.left));
      return clipOffset;
    };
    getOverlayOffset = function() {
      return overlayOffset = overlay.get(0).getBoundingClientRect();
    };
    getCollidingBlocks = function() {
      collidingBlocks = [];
      return allBlocks.each(function() {
        var blockOffset;
        blockOffset = this.getBoundingClientRect();
        if ((blockOffset.bottom >= overlayOffset.top) && (blockOffset.top <= overlayOffset.bottom) && (blockOffset.left <= overlayOffset.right) && (blockOffset.right >= overlayOffset.left)) {
          return collidingBlocks[$(this).data("" + settings.dataAttribute + "-id")] = blockOffset;
        }
      });
    };
    clipOverlay = function(clone, offset) {
      if (settings.simpleMode === 'vertical') {
        $(clone).css({
          'clip': "rect(" + offset[0] + "px auto " + offset[2] + "px auto)"
        });
        return $(overlay).css({
          'clip': "rect(" + (-offset[2]) + "px auto " + offset[0] + "px auto)"
        });
      } else if (settings.simpleMode === 'horizontal') {
        return $(clone).css({
          'clip': "rect(auto " + offset[1] + "px auto " + offset[3] + "px)"
        });
      } else {
        return $(clone).css({
          'clip': "rect(" + offset[0] + "px " + offset[1] + "px " + offset[2] + "px " + offset[3] + "px)"
        });
      }
    };
    refresh = function() {
      getOverlayOffset();
      getCollidingBlocks();
      return updateOverlayClones();
    };
    attachListeners = function() {
      return $(window).on("" + (settings.updateOnResize ? 'resize' : void 0) + " " + (settings.updateOnScroll ? 'scroll' : void 0), function() {
        return refresh();
      });
    };
    init = function() {
      var autoUpdateTimer;
      getAllBlocks();
      if (allBlocks.length > 0) {
        addIdToBlocks();
        createOverlayClones();
        attachListeners();
        refresh();
        clearInterval(typeof autoUpdateTimer !== "undefined" && autoUpdateTimer !== null);
        if (settings.autoUpdate) {
          return autoUpdateTimer = setInterval((function() {
            return refresh();
          }), settings.autoUpdateInterval);
        }
      }
    };
    return init();
  };

}).call(this);
